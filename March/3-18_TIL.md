# Terraform State

---

<aside>
📖

Terraform이 코드를 바탕으로 인프라를 구축하는 방식

- apply할 때마다 모든 인프라의 정보를 저장하는 state 파일 생성
- tfstate 확장자를 갖는 파일을 자동으로 생성/수정
- 상태 파일과 현재 AWS 계정에 반영된 인프라의 상태를 비교하는 방식으로 변경사항 파악
</aside>

- 상태 파일 관리 방법
    - 개인 프로젝트
        - 변경사항을 유발하는 주체가 개인이므로 문제 ❌
    - 협업 프로젝트
        - 팀 단위 프로젝트에서 팀 동료와 함께 코드 및 상태에 접근할 수 있는 방법 필요
        - Terraform 상태 파일은 모든 구성원에게 항상 최신 상태만 보여져야 함
        - Solution - 상태 파일을 저장하는 공유 저장소가 별도로 필요(S3)

### Terraform에 내장된 Remote State Storage 사용

- Terraform 명령어 실행마다 공유 저장소에 위치한 상태 파일을 사용하도록 지정
- 공유 저장소는 S3. Azure Storage, Hashicorp 등
- S3 강점
    - Fully managed 서비스이므로 관리 비용 ❌
    - 암호화 지원
    - S3 버전 관리 기능을 통한 복구

### 데브옵스에서의 CI/CD 체계

![스크린샷 2025-03-18 오전 10.36.05.png](/images/3-18_1.png)

- Terraform 용 Repository 생성
    - Dev, Prod 환경을 따로따로 각각 구성
- 전체적인 순서
    1. 워크 스페이스 생성
    2. 테라폼 init
    3. 테라폼 play
    4. 테라폼 apply (3 - 4 사이 과정은 수동으로 하는 것이 좋음)

### CI

<aside>
📖

지속적 통합

개발자가 자주 코드 변경 사항을 중앙 저장소에 통합

</aside>

### CD

<aside>
📖

지속적 전달 

CI 과정을 거친 코드를 실제 환경과 유사한 환경에 배포

실제 운영환경에 배포 전 최종 검토 및 승인

</aside>

표면적으로는 빌드 + 테스트 + 배포가 자동으로 이뤄진다는 것이 좋아보일 수 있으나 실제 업무로 가면 이게 오래걸려서 테스트를 건너뛰고 빌드 후 바로 배포하는 경우가 많음

### IaC 관리 방법

코드형 인프라 또한 코드 → Code repository 및 빌드 환경 필요

배포의 결과물은 이프라 → 테스트 환경 필요

- 상태파일 분리
    - 개발 및 운영 환경에 대한 인프라를 독점적으로 관리하기 위해 상태파일을 분리
    - 사람에 의한 실수를 줄이고 자동화된 테스트 및 배포를 하기 위함
- 개발 환경과 운영 환경 분리의 필요성
    - 하나의 Tf파일에서 개발 및 테스트, 운영 환경을 생성하는 모든 인프라를 관리하는 경우, 실수에 의해 모든 환경에 대한 변경사항이 발생할 수 있음
    - 각각 환경에 대한 별도의 상태 파일이 생성될 수 있도록 프로젝트를 구성해야 함

# Amazon ECR

---

<aside>
📖

AWS에서 제공하는 완전한 관리형 Docker 컨테이너 레지스트리 서비스

Docker 컨테이너 이미지를 안전하고 안정적으로 저장, 관리 및 배포 가능

</aside>

- 레지스트리
    - AWS 계정에 제공되는 프라이빗 리포지토리
    - AWS 환경 내에 Docker 이미지, Open Container Initiative 이미지 및 기타 OCI 호환 아티팩트 저장 및 배포 가능
        
        <aside>
        📖
        
        OCI
        
        컨테이너의 표준을 정의하는 오픈 소스 프로젝트
        
        컨테이너의 형식과 실행 방식을 표준화하기 위한 규칙
        
        Docker, Kubernetes, Podman, CRI-O같은 컨테이너 기술들이 서로 호환되도록 만든 표준
        
        특별하게 사용할 이유가 없다면 그냥 도커 이미지를 쓰는게 편함 (도커 ❌, containerd..)
        
        </aside>
        
- 권한 부여 토큰
    - 클라이언트는 프라이빗 레지스트리에 인증을 해야 이미지를 푸시하고 가져올 수 있음
- 수명 주기 정책
    - 오래된 이미지나 미사용 이미지를 정리하고 만료시키는 규칙을 정의하여 수명 주기를 관리할 수 있음
- 이미지 스캔
    - 컨테이너 이미지의 소프트웨어 취약성을 식별하는 데 도움을 주는 통합 이미지 스캔 기능 제공

## 사용 사례

### 컨테이너 이미지 저장 및 배포

- Docker 컨테이너 이미지를 저장 및 배포하거나 공개 사용을 위해 제공하는 중앙 집중식 리포지토리 역할을 함
- 개발자는 컨테이너 이미지를 Amazon ECR로 푸시한 다음 Amazon EC2 또는 Amazon EKS AWS와 같은 내 컴퓨팅 환경에서 가져올 수 있다.

### 지속적인 통합 및 지속적인 배포(CI/CD)

- Amazon ECR은 AWS CodeBuild AWS CodePipeline 및 기타 CI/CD 도구와 원활하게 통합되어 컨테이너화된 애플리케이션의 자동 구축, 테스트 및 배포를 지원
