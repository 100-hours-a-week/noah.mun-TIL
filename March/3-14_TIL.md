# Elastic Kubernetes Service

---

## Elastic Kubernetes Service (EKS)ë€?

- AWSì—ì„œ K8Së¥¼ ìš´ì˜í•  ìˆ˜ ìˆë„ë¡ ì œê³µí•´ì£¼ëŠ” ê´€ë¦¬í˜• kubernets ì„œë¹„ìŠ¤
    - Control Planeì„ ì§ì ‘ í”„ë¡œë¹„ì €ë‹í•˜ê±°ë‚˜ ê´€ë¦¬í•˜ì§€ ì•Šì•„ë„ ë˜ëŠ” í¸ì˜ì„±
    - ì›Œí¬ ë¡œë“œê°€ ì‹¤í–‰ë˜ëŠ” ë…¸ë“œ êµ¬ì„±ì— ëŒ€í•œ ììœ ë„
    - ì—¬ëŸ¬ ê°€ìš© ì˜ì—­(AZ) ê¸°ë°˜ì˜ ê³  ê°€ìš©ì„± ì œê³µ
    - í¸ë¦¬í•œ í´ëŸ¬ìŠ¤í„° ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
    - AWS ì„œë¹„ìŠ¤ë“¤ê³¼ì˜ í†µí•©

## EKS êµ¬ì„±

- Controle Planeê³¼ Data Plane
    - Control Plane : í´ëŸ¬ìŠ¤í„°ì˜ ë¸Œë ˆì¸ ì—­í• 
    - Data Plane : Podë¥¼ í†µí•´ ì‹¤ì œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì‹¤í–‰
    - EKS VPC
        
        ![image.png](/images/3_14_1.png)
        
        EC2 ì•„í‚¤í…ì²˜ì—ì„œëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ ì¡´ì¬í•˜ì˜€ì§€ë§Œ EKS ê¸°ë³¸ ì•„í‚¤í…ì²˜ì—ì„œëŠ” Master Nodeê°€ VPC ì™¸ë¶€ì— ì¡´ì¬í•˜ì—¬ Worker Nodeë¥¼ ì»¨íŠ¸ë¡¤í•œë‹¤.
        

## Container Services

- Amazon Elastic Kubernetes Service(EKS)
- Amazon Elastic Container Service(ECS)
- Amazon Elastic Container Registry(ECR)
    
    ë³´í†µ ECRì— ì €ì¥ëœ ì´ë¯¸ì§€ë“¤ì„ EKSë‚˜ ECSë¡œ ì‹¤í–‰ì‹œí‚¤ëŠ” ê²ƒì´ ì¼ë°˜ì 
    

## EKS Cluster

- í´ëŸ¬ìŠ¤í„° í•˜ë“œì›¨ì–´ ì•„í‚¤í…ì²˜
    - Default VPC : Bastion ì„œë²„
        - Ubuntu Linux OS, aws CLI eksctl, kubectl
        - Docker container build ë° ì»¨í…Œì´ë„ˆ push
    - EKS cluster
        
        ![á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2025-03-14 á„‹á…©á„Œá…¥á†« 11.45.53.png](/images/3_14_2.png)
        

## EKSë¡œ ì¿ ë²„ë„¤í‹°ìŠ¤ í™˜ê²½ êµ¬ì¶•í•˜ê¸°

---

1. Bastion ì„œë²„ êµ¬ì¶•
    - ec2ë¡œ Bastion ì„œë²„ êµ¬ì¶• í•œ ë‹¤ìŒ sshë¡œ ì ‘ì†
    - `curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"` ëª…ë ¹ì–´ë¥¼ í†µí•´ aws cliì— ì ‘ì†
        
        ***aws clië€?***
        
        - AWS ì„œë¹„ìŠ¤ë¥¼ ëª…ë ¹ì–´ë¡œ ì¡°ì‘í•  ìˆ˜ ìˆë„ë¡ ì œê³µí•˜ëŠ” ë„êµ¬
        - AWS ì½˜ì†”ì—ì„œ í´ë¦­í•˜ë©° ì„¤ì •í•˜ëŠ” ë°©ì‹ì´ ì•„ë‹ˆë¼, í„°ë¯¸ë„ ë˜ëŠ” í”„ë¡¬í”„íŠ¸ì—ì„œ AWS ë¦¬ì†ŒìŠ¤ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•´ì¤Œ
    - `/usr/local/bin/aws --version` ëª…ë ¹ì–´ë¥¼ í†µí•´ aws cliê°€ ì˜ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
    - `aws configure` ëª…ë ¹ì–´ë¡œ ì‚¬ì „ì— ë°œê¸‰ë°›ì•˜ë˜ public access í‚¤, secret access í‚¤ë¥¼ ì…ë ¥ í›„ ë³¸ì¸ region, format typeì„ ì…ë ¥í•˜ì—¬ cliì— ì ‘ì†
    - `aws sts get-caller-identity` ë¡œ ì˜ ë“¤ì–´ì™”ë‚˜ í™•ì¸
2. Amazon Document ì‚¬ì´íŠ¸ì—ì„œ ê°€ì´ë“œí•œ ëŒ€ë¡œ kubectl ì„¤ì •
    - `curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.32.0/2024-12-20/bin/linux/amd64/kubectl`
    - `chmod +x ./kubectl`
    - `mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$HOME/bin:$PATH`
    
    ```bash
    ARCH=amd64
    PLATFORM=$(uname -s)_$ARCH
    
    curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz"
    
    ```
    
    - `tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && rm eksctl_$PLATFORM.tar.gz`
    - `sudo mv /tmp/eksctl /usr/local/bin`
    - `eksctl version`
3. kubectl í´ëŸ¬ìŠ¤í„° ìƒì„± (Amazon ê³µì‹ ë¬¸ì„œì— ì˜ ë‚˜ì™€ìˆìŒ)
    - `eksctl create cluster --name test-eks --region us-west-2 â€”with-oidc â€”zones us-west-2a,us-west-2c â€”nodes 2 â€”node-type t3.medium â€”node-volume-size=20 â€”managed` ì„¤ì¹˜ 10ë¶„ ì •ë„ ê±¸ë¦¬ë”ë¼ (ë…¸ë“œê·¸ë£¹ ì„¤ì •í•´ì¤˜ì•¼ íŒŒë“œ ì¸ìŠ¤í„´ìŠ¤ë“¤ë„ ìë™ìœ¼ë¡œ ìƒì„±ë¨)
    - `kubectl get svc`, `kubectl get pods` ëª…ë ¹ì–´ë“¤ë¡œ í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì˜ ìƒíƒœë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŒ
    - `kubectl edit svc <í´ëŸ¬ìŠ¤í„° ì´ë¦„>` ì•ˆì— ë“¤ì–´ê°€ì„œ type ë³€ìˆ˜ ë³€ê²½ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° íƒ€ì… ë³€ê²½í•  ìˆ˜ ìˆìŒ
        
        <aside>
        ğŸš¨
        
        ê·¼ë°Â ì—¬ê¸°ì„œ ec2 í¼ë¸”ë¦­ ipë¡œ ì ‘ì†í•˜ë ¤í•˜ë©´ ë°©í™”ë²½ë•Œë¬¸ì— ì ‘ì† ê±°ë¶€ë¨ ì´ëŸ´ ë•ŒëŠ” ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì •í•´ì„œ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ ì ‘ì†í•˜ë©´ í•´ê²°ë¨
        
        </aside>
        

1. Helmì„ ì‚¬ìš©í•˜ì—¬ AWS load Balancer Controller ì„¤ì¹˜
    - í—¬ë¦„ë¶€í„° ì„¤ì¹˜í•´ì•¼ í•¨
        
        í—¬ë¦„ ì„¤ì¹˜ ëª…ë ¹ì–´
        
        ```bash
        $ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        $ chmod 700 get_helm.sh
        $ ./get_helm.sh
        ```
        
    - ì‚¬ìš©ì ëŒ€ì‹  AWS APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë¡œë“œ ë°¸ëŸ°ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ì˜ IAM ì •ì±…ì„ ìƒˆë¡œ ìƒì„±í•´ì¤˜ì•¼ í•¨
        
        `curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.11.0/docs/install/iam_policy.json` 
        
        ```bash
        # curlë¡œ ë‹¤ìš´ë¡œë“œí•œ ì •ì±…ì„ ì‚¬ìš©í•´ì„œ IAM ì •ì±…ì„ ë§Œë“¦
        aws iam create-policy \
            --policy-name AWSLoadBalancerControllerIAMPolicy \
            --policy-document file://iam_policy.json
        ```
        
        ë¡œ í•´ë„ ë˜ê³  ì½˜ì†”ì— ë“¤ì–´ê°€ì„œ ì§ì ‘ ì¶”ê°€í•´ì¤˜ë„ ë¨
        
    - service account ìƒì„±
        
        ```bash
        eksctl create iamserviceaccount \
          --cluster=<esk í´ëŸ¬ìŠ¤í„° ì´ë¦„> \
          --namespace=kube-system \
          --name=aws-load-balancer-controller \
          --role-name AmazonEKSLoadBalancerControllerRole \
          --attach-policy-arn=<ë³¸ì¸ ì •ì±… DNS> \
          --approve
        ```
        
    - AWS Load Balancer Controller ì„¤ì¹˜
        1. eks-charts ì°¨íŠ¸ Helm ë ˆí¬ì§€í† ë¦¬ë¥¼ ì¶”ê°€
            
            `helm repo add eks https://aws.github.io/eks-charts`
            
        2. ìµœì‹  ì°¨íŠ¸ê°€ ì ìš©ë˜ë„ë¡ ë¡œì»¬ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì—…ë°ì´íŠ¸
            
            `helm repo update eks` 
            
        3. AWS ë¡œë“œ ë°¸ëŸ°ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜
            
            ```bash
            helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
              -n kube-system \
              --set clusterName=<ë³¸ì¸ í´ëŸ¬ìŠ¤í„° ì´ë¦„> \
              --set serviceAccount.create=false \
              --set serviceAccount.name=aws-load-balancer-controller
            ```
            
    - ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜ í™•ì¸
        
        `kubectl get deployment -n kube-system aws-load-balancer-controller` 
        
2. ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
    - fargate í”„ë¡œí•„ ìƒì„±
        
        ```bash
        eksctl create fargateprofile \
            --cluster <ë³¸ì¸ í´ëŸ¬ìŠ¤í„° ì´ë¦„> \
            --region region-code \
            --name nlb-sample-app \
            --namespace nlb-sample-app
        ```
        
    - ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
        - ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„± - `kubectl create namespace nlb-sample-app`
        - sample-deployment.yaml íŒŒì¼ì— ë‹¤ìŒ ë‚´ìš© ì €ì¥
            
            ```bash
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: nlb-sample-app
              namespace: nlb-sample-app
            spec:
              replicas: 3
              selector:
                matchLabels:
                  app: nginx
              template:
                metadata:
                  labels:
                    app: nginx
                spec:
                  containers:
                    - name: nginx
                      image: public.ecr.aws/nginx/nginx:1.23
                      ports:
                        - name: tcp
                          containerPort: 80
            ```
            
        - ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ì ìš©
            
            `kubectl apply -f sample-deployment.yaml` 
            
    - IP ëŒ€ìƒì— ëŒ€í•œ ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰í•˜ëŠ” ì¸í„°ë„·ì´ ì—°ê²°ëœ NLBë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±
        - sample-service.yaml íŒŒì¼ì— ë‹¤ìŒ ë‚´ìš©ì„ ì €ì¥
            
            ```bash
            apiVersion: v1
            kind: Service
            metadata:
              name: nlb-sample-service
              namespace: nlb-sample-app
              annotations:
                service.beta.kubernetes.io/aws-load-balancer-type: external
                service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
                service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
            spec:
              ports:
                - port: 80
                  targetPort: 80
                  protocol: TCP
              type: LoadBalancer
              selector:
                app: nginx
            ```
            
        - ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ì ìš©
            
            `kubectl apply -f sample-service.yaml`
            
        - ì„œë¹„ìŠ¤ê°€ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
            
            `kubectl get svc nlb-sample-service -n nlb-sample-app` 
            
        
        <aside>
        ğŸš¨
        
        ì¶”ê°€ì ì¸ ì •ë³´ê°€ ê¶ê¸ˆí•˜ë‹¤ë©´ AWS ê³µì‹ í™ˆí˜ì´ì§€ ë“¤ì–´ê°€ì„œ ì‚¬ìš©ì ê°€ì´ë“œ ê´€ë ¨ ë‚´ìš© í™•ì¸í•´ë³´ë©´ ë¨ ì—¬ê¸°ê°€ ì œì¼ ì˜ ë¼ìˆì–´ì„œ ë‹¤ë¥¸ ë° ë³¼ í•„ìš”ê°€ ì—†ìŒ
        
        </aside>
