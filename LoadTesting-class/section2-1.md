# Section 2

---

## 병목 지점 (Bottleneck Point)

<aside>
📖

부하테스트에서 병목 지점이란, 전체 시스템에서 특정 서버 자원(CPU, Memory 등)이 한계애 도달해 전체 성능이 저하되는 구간을 의미한다.

고속도로에 비유하자면 길이 갑자기 좁아지는 구간에서 차가 확 막히는 경우가 많다. 3차선 도로가 소화할만한 차들이 갑자기 2차선으로 몰려들면서 정체가 발생한다. 그럼 2차선 구간에서 발생한 정체를 보고 병목 지점이라고 얘기한다.

![스크린샷 2025-03-09 오전 10.55.47.png](/images/2-1.png)

전체적인 고속도로 정체를 해결하기 위해서는 교통 정체가 일어난 곳을 해결해야 한다. 정체가 없는 3차선 도로를 아무리 넓혀봤자 2차선 도로 정체가 나아지기는 커녕 더 심해진다.

이와 비슷하게 시스템의 성능을 개선하기 위해서는 ‘병목 지점’을 개선해야 한다.

</aside>

### ✅ 병목 지점의 Throughput이 전체 Throughput이다.

`사용자 ↔ 백엔드 서버 ↔ DB`의 구조에서 백엔드 서버가 1초에 1,000개의 요청을 처리할 수 있고, DB가 1초에 300개의 요청을 처리할 수 있다고 가정하면, 전체 시스템에서 처리할 수 있는 요청의 양은 300개이다.

### ✅ 특정 병목 지점을 해소하면 다른 곳에서 새로운 병목 지점이 발생한다.

위 사례에서 B - C 구간의 병목을 해소했다고 가정하면, 또 다시 A - B 구간이 병목이 생길 수 밖에 없다.

이런 예를 통해 특정 병목 지점을 해소하면 다른 곳에서 새로운 병목 지점이 발생한다는 것을 알 수 있다.

## 부하 테스트의 전체 흐름

### 1️⃣ 부하 테스트 필요성 인식

- 서비스를 오픈하려고 하는데 사용자들이 몰려서 서버가 터지면 어떡하지?
- 내 서버는 어느 정도 사용자 요청을 견딜 수 있는 거지?
- 개발자님, 이번에 치킨 이벤트를 하려는데 사용자가 1만명 정도 들어와도 서버가 버틸까요?

### 2️⃣ 부하 테스트 목표 설정하기

- 부하 테스트 목표는 주로 Throughput과 Latnecy를 활용해 결정한다.

[예시]

- 목표 TPS : 2000TPS
    - 서비스에 예상 접속자 수, 예상 요청 수 등을 활용해 TPS 목표를 설정
- 평균 Latency : 800ms
    
    서비스의 특성에 맞게 Latency를 설정
    

### 3️⃣ 현재 시스템이 어느 정도 트래픽까지 견딜 수 있는 지 부하 테스트 진행

- 부하 테스트 툴을 활용해 시스템에 부하를 줌
- 부하의 정도를 올려가면서 어느 정도 부하까지 견딜 수 있는 지 측정 즉, 시스템의 최대 Throughput을 측정

### 4️⃣ 병목 지점 파악 후 성능 개선하기

- 목표로 설정한 Throughput, Latency를 달성하기 위해 기존 시스템의 성능을 개선해야 할 수도 있다.
- 성능 개선을 하려면 가장 먼저 병목 지점을 파악하여 그 부분을 개선해야 한다.

### 5️⃣ 개선한 시스템이 어느 정도 트래픽까지 견딜 수 있는 지 부하 테스트 진행

- 개선한 시스템이 어느 정도 트래픽까지 견딜 수 있는 지 부하 테스트를 진행한다. 부하 테스트를 통해 최대 Throughput과 평균 Latnecy를 측정해서 목표치를 달성했는 지 체크한다.
- 만약 목표치를 달성하지 못했다면 다시 4번 과정을 거친 후 부하 테스트를 진행해서 목표치 달성 여부를 확인한다. 이 괒어을 목표 달성 때까지 반복한다.

## 부하 테스트 시 주의점

### ✅ 적절한 부하 테스트 시간

1분 간격으로 기록되는 모니터링 도구를 가지고 정확하게 성능을 측정하려면 최소 5분간의 부하 테스트는 진행해야한다. 그래야 일관된 결과값을 얻을 수 있다.

현업에서 부하 테스트를 할 때는 프로덕션 환경에 저장되어 있는 데이터의 양만큼 세팅을 해두고 부하 테스트를 진행한다. 이 과정을 조금 더 간소화하기 위해서는 프로덕션 환경의 데이터들이 포함된 DB 복제번을 떠서 그 DB로 부하 테스트를 진행하기도 한다.

### ✅ 프로덕션과 분리된 환경에서 테스트하기

프로덕션 환경에서 부하 테스트를 하면 ❌

→ 부하 테스트를 함으로써 실제 서비스의 성능에 악영향을 끼칠 수 있기 때문이다.

### ✅ 모니터링이란?

<aside>
📖

어떠한 대상을 지속적으로 감시한다는 뜻

</aside>

> 부하테스트에서 모니터링이 필요한 이유
> 

부하 테스트 과정에서 성능을 개선하려면 병목 지점을 먼저 파악해야 한다. 병목 지점을 파악하기 위해서는 각 ‘컴퓨터’의 CPU 사용률과 메모리 사용률과 같은 값들을 지속적으로 확인할 수 있어야 한다.

여기서 얘기하는 컴퓨터는 로드 밸런서(ELB), 백엔드 서버(EC2), DB(RDS), 캐시(ElasticCache) 등을 얘기한다. 무언가 요청을 받아서 처리하는 형태의 서비스는 전부 컴퓨터에서 처리하기 때문이다.

컴퓨터가 무언가를 처리하려면 **CPU, 메모리같은 자원**이 필요하다. 만약 컴퓨터가 처리할 수 있는 최대한의 요청을 처리하고 있다면, CPU 사용률 또는 메모리 사용률과 같은 값이 100%일 것이다. 여기서 **특정 자원 사용률이 100%인 컴퓨터를 보고 병목 지점이라고 판단**한다.

위 내용을 정리해보면, 병목 지점을 파악하기 위해서 부하 테스트를 하면서 컴퓨터의 자원(CPU, 메모리 등)을 모니터링해야 한다.

### ✅ 메트릭(Metric)이란?

<aside>
📖

수치 데이터 또는 측정값을 의미한다. 모니터링을 통해 측정하는 **CPU, 메모리** 등의 값을 전부 메트릭(Metric)이라고 부른다.

</aside>

## CPU, 메모리, 디스크

### ✅ CPU, 메모리, 디스크 의미

***[CPU]***

- 명령어(코드)를 해석하고 실행
- 연산 작업

***[메모리]***

- CPU가 작업하기 위해 임시로 사용하는 공간
    - 디스크보다 메모리로부터 데이터를 가져올 때 속도가 훨씬 빠르기 때문
    - CPU는 명령어를 해석해서 실행하거나 연산 작업을 할 때는 무조건 메모리를 통해서만 데이터를 가져온다. 디스크에 직접 접근 ❌
- 실행할 프로그램의 코드, 변수(전역 변수, 매개 변수 …)
- RAM이라 부르기도 함

***[디스크]***

- C드라이브와 같은 **컴퓨터 저장 공간**
- 영구적으로 데이터, 파일 등을 저장
- 데이터를 가져올 때 속도가 상대적으로 느림

### ✅ CPU, 메모리의 직관적인 이해

1. CPU를 많이 사용하는 작업
    
    ```jsx
    let num = 1;
    while (ture) {
    	num += 1;
    }
    ```
    
2. 메모리를 많이 사용하는 작업
    
    ```jsx
    while (true) {
    	let largeArray = [];
    	for (let i = 0; i < 10000000; i++) {
    		largeArray.push(i);
    	}
    }
    ```
    

### ✅ CPU, 메모리, 디스크의 직관적인 이해를 위한 연습

1. DB는 CPU, 메모리, 디스크를 어떻게 사용할까?
    - `디스크`로부터 데이터를 조회해서 `메모리`에 올림
    - `메모리`에서 연산, 필터링, 집계 등의 작업을 `CPU`가 처리함
        
        ⇒ DB의 특성상 많은 양의 데이터를 가지고 작업해야 하는 경우가 빈번하여 `CPU`, `메모리` 둘 다 많이 쓰는 편이다.
        
2. 백엔드 서버는 CPU, 메모리, 디스크를 어떻게 사용할까?
    - 백엔드 서버의 로직에 파일을 읽어오거나, 파일을 생성하는 로직이 없다면 디스크는 거의 사용할 일이 없다.
        - 파일 업로드나 파일 조회 같은 것은 S3와 같은 서비스를 활용해 별도로 분리하는 추세
    - DB로부터 불러오는 데이터의 양의 그렇게 크지 않을 경우 `메모리`를 많이 사용할 일 ❌
    - 많은 요청에 대해 로직을 처리해야 하기 때문에 `CPU`를 많이 사용
    - 복잡한 연산 작업(인코딩, 디코딩, 암호화)을 사용할 경우 `CPU`를 많이 사용함
3. 로드 밸런서는 CPU, 메모리, 디스크를 어떻게 사용할까?
    - 요청이 들어오면 적절하게 서버들에게 골고루 트래픽을 분배해주는 역할을 함
        - 임시로 저장해야 하는 데이터가 많은 게 아니기 때문에 `메모리`를 많이 사용 ❌
    - 많은 요청을 분배해주는 로직(=연산)을 처리하기 때문에 `CPU`를 많이 사용
4. 캐시(Redis)는 CPU, 메모리, 디스크를 어떻게 사용할까?
    - 캐시의 특성상 빠르게 데이터를 조회해야 하기 때문에 디스크에 데이터를 저장하지 않고 `메모리`에 데이터를 저장해둔다.
        - 디스크보다 `메모리`가 데이터 접근 속도(읽기, 쓰기)가 훨씬 빠르기 때문
    - 캐시의 주 역할은 데이터 조회다. 연산할만한 작업은 많이 없다. 따라서 `CPU`보다는 `메모리`를 많이 사용하는 편이다.

### ✅ Disk I/O, Network I/O란?

<aside>
📖

서버의 성능을 측정할 때 CPU, 메모리 이외에도 Disk I/O, Network I/O와 같은 다양한 값들이 있다. 하지만 입문자 입장에서는 너무 많은 메트릭을 한 번에 이해하려고 하면 어렵게 느껴짐

실제 AWS 클라우드를 사용하면 대부분 CPU, 메모리 부족으로 인해 병목 현상이 발생한다. 따라서 CPU, 메모리 이 2가지 메트릭만 가지고 부하 테스트 및 성능 개선 연습을 할 것

</aside>
